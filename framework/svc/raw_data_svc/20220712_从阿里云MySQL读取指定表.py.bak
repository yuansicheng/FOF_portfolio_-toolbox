# -*- coding: utf-8 -*-
"""
by lxw 20220712

从服务器MySQL读取数据，保存为.h5文件。

IP：101.132.119.106
端口：3306
user：magi_winddb
pwd：MAGIwinddb666
数据库：winddb_alicloud

"""

import pymysql
import pandas as pd
import time
import warnings
warnings.filterwarnings('ignore')

# 数据存放地址 
DB_LOC =  r'.'

def loadAllTable(db_table, save=True, by_year=False):
    '''
    读取指定表格的所有数据
    db_table含有三个参数：
        db_table[0]: 表名称
        db_table[1]: 证券代码字段
        db_table[2]: 日期字段
    '''

    # MySQL
    conn = pymysql.connect(
        host='101.132.119.106',
        user='magi_winddb',
        password="MAGIwinddb666",
        db='winddb_alicloud',
        port=3306,
        charset='GBK')
    
    table_name = db_table[0]
    order_windcode = db_table[1]
    order_date = db_table[2]

    ### 一次性读取整张表    
    if by_year == False:
        sql = """
        SELECT * 
        FROM {}
        """.format(table_name)
        
        start_time = time.perf_counter()
        data_all = pd.read_sql(sql,conn)
        end_time = time.perf_counter()    
        cost_time = round(end_time - start_time, 4)
        print(r'Table [{}] loaded.  Time costed: {} min {} sec.'.format(table_name, cost_time//60, cost_time%60))
        
        if order_windcode != '' and order_date != '':
            data_all.sort_values(by=[order_windcode,order_date], inplace=True)  # 数据排序
        
        if save == True:     # 保存数据
            today_date = time.strftime('%Y%m%d',time.localtime(time.time()))  
            data_all.to_hdf(r'{}/{}_{}.h5'.format(DB_LOC, table_name, today_date), key='df')
   
    ### 分年度读取表数据(适用于行情数据等数据量过大的表)
    else:
        sql_start_date = 'select min({}) from {}'.format(order_date, table_name)
        start_date = pd.read_sql(sql_start_date,conn).iloc[0][0]
        start_year = int(start_date[0:4])
        
        sql_end_date = 'select max({}) from {}'.format(order_date, table_name)
        end_date = pd.read_sql(sql_end_date,conn).iloc[0][0]
        end_year = int(end_date[0:4])
        
        # 分年度读取表数据 
        data = {}
        for year in range(start_year,end_year+1):
            sql = """
            SELECT * 
            FROM {} where {} >= '{}-01-01' and {} <= '{}-12-31'
            """.format(table_name, order_date, year, order_date, year)
            
            
            start_time = time.perf_counter()
            data[year] = pd.read_sql(sql,conn)
            end_time = time.perf_counter()    
            cost_time = round(end_time - start_time, 4)
            print(r'[{}] - [{}] loaded.  Time costed: {} min {} sec.'.format(year, table_name, cost_time//60, cost_time%60))
            
            # 此处进行逐年保存，后续再做处理
            # data[year].to_hdf(r'{}/{}_{}.h5'.format(DB_LOC, table_name, year), key='df')
            
            
        # #合并数据
        data_all = pd.concat([data[x] for x in range(start_year,end_year+1)])
        
        # 排序
        if order_windcode != '' and order_date != '':
            data_all.sort_values(by=[order_windcode,order_date], inplace=True)  
        if save == True:     # 保存数据
            today_date = time.strftime('%Y%m%d',time.localtime(time.time()))  
            data_all.to_hdf(r'{}/{}_{}.h5'.format(DB_LOC, table_name, today_date), key='df')
            
    conn.close()
    return data_all


# 行情数据量较大容易出现连接错误，建议单独下载
update_table_wind = [                 
            ### 00 代码表
            'AShareIndustriesCode',    # 行业代码
            'IndexContrastSector',     # 指数板块对照             
            
            ### 01 中国A股数据库
            ## 01-01 中国A股-基础信息
            'AShareDescription',        # 中国A股基本资料
            'AShareRegional',          # 中国A股企业地域板块
            'AShareConseption',        # 中国A股Wind概念板块
            'SHSCMembers',             # 沪股通成分股
            'SZSCMembers',             # 深股通成分股
            
            ## 01-02 中国A股-行情交易数据
            'AShareCalendar',          # 中国A股交易日历
            'AShareEODPrices',         # 中国A股日行情
            'AShareStrangeTradedetail', # 中国A股交易异动
            'AShareStrangeTrade',       # 中国A股交易异动营业部买卖信息
            'AShareBlockTrade',         # 中国A股大宗交易数据
            'AShareMarketOverallindex',    # 沪深市场总体指标(月)
            
            ## 01-15 中国A股-指数数据            
            'AIndexDescription',       # 中国A股指数基本资料
            'AIndexMembers',           # 中国A股指数成分股
            'AIndexEODPrices',         # 中国A股指数日行情
            
            ## 01-98 中国A股第三方数据            
            'AIndexIndustriesEODCITICS',    # 中国A股中信行业指数日行情
            'AShareIndustriesClassCITICS',    # 中国A股中信行业分类
             
            ### 04 中国共同基金数据库
            ## 04-01 共同基金-基础信息
            'ChinaMutualFundDescription',    # 中国共同基金基本资料
            'ChinaMutualFundManager',        # 中国共同基金基金经理
            'CMFIndustryPlate',    # 中国共同基金WIND行业板块主题分类
            'CMFThemeConcept',     # 中国共同基金WIND概念板块主题分类
            'CMFConseption',       # 中国共同基金WIND概念分类信息
            'ChinaMutualFundSector', # 中国Wind基金分类
            'CMFMGQualifications',   # 中国共同基金基金经理资历表
            
            ## 04-04 共同基金-市场表现
            'ChinaMutualFundNAV',            # 中国共同基金净值
            'ChinaClosedFundEODPrice',     # 中国上市基金日行情
            'ChinaMutualFundRepNAVPer',      # 中国共同基金净值表现(报告期)
            
            ## 04-06 共同基金-申购赎回
            'ClosedFundPchRedm',    # 中国封闭式基金场内申购赎回
            'ETFPchRedm',    # 中国ETF申购赎回
            'LOFPchRedm',    # 中国开放式基金场内申购赎回
            'ChinaMutualFundPchRedm',    # 中国共同基金申购赎回情况
            
            ## 04-07 共同基金-投资组合
            'ChinaMutualFundAssetPortfolio', # 中国共同基金投资组合——资产配置
            'ChinaMutualFundIndPortfolio',   # 中国共同基金投资组合——行业配置
            'ChinaMutualFundStockPortfolio',  # 中国共同基金投资组合——持股明细
            'ChinaMutualFundBondPortfolio',   # 中国共同基金投资组合——持债券明细
            'CMFundThirdPartyIndPortfolio',  # 中国共同基金投资组合第三方行业配置

            ### 05 中国期货数据库
            ## 05-01 期货-基础信息
            'CFuturesDescription',    # 中国期货基本资料
            'CFuturesContPro',    # 中国期货标准合约属性
            'CFturesPriceChangeLimit',    # 中国期货标准合约价格波动限制变更
            'FuturesExchangeProductCode', # 中国期货交易所标准产品代码
            'CFuturesContractMapping',    # 中国期货连续（主力）合约和月合约映射表
            'CFuturesMarginRatio',        # 中国期货保证金比例
            'CFuturesCalendar',           # 中国期货交易日历
            'CFuturesArbitrageContract',  # 中国期货套利合约关系表    
            'CFuturesDeliveryFee',  # 中国期货交易交割手续费    

            ## 05-04 期货-商品期货
            'CCommodityFuturesEODPrices',    # 中国商品期货日行情
            
            ## 05-05 期货-股指期货
            'CIndexFuturesEODPrices',    # 中国股指期货日行情 
            
            ### 08 香港股票数据库
            ## 08-01 香港股票-基础信息
            'HKCompanyInfo',        # 香港股票上市公司基本资料
            'HKShareDescription',   # 香港股票基本资料
            
            ## 08-04 香港股票-行情交易数据
            'HKEXCalendar',         # 香港交易所交易日历
            'HKShareEODPrices',     # 香港股票日行情
            'SHSCChannelHoldings',  # 陆港通通道持股数量统计(中央结算系统)
            'SHSCDailyStatistics',  # 陆港通日交易统计
            'SHSCTop10ActiveStocks',# 陆港通日十大成交活跃股统计
        ]


for table_name in update_table_wind:
    db_table = (table_name, '', '')
    loadAllTable(db_table)


#%%

# today_date = time.strftime('%Y%m%d',time.localtime(time.time())) 
# check = pd.read_hdf(r'{}/{}_{}.h5'.format(DB_LOC, db_table[0], today_date))

